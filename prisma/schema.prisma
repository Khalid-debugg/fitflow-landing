generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ActivatedDevice {
  id              String   @id @default(cuid())
  userId          String
  deviceId        String   @db.VarChar(255)
  deviceName      String?  @db.VarChar(100)
  platform        String   @db.VarChar(20)
  appVersion      String   @db.VarChar(20)
  activatedAt     DateTime @default(now())
  lastValidatedAt DateTime @default(now())
  isActive        Boolean  @default(true)
  trialStartedAt  DateTime?
  trialEndsAt     DateTime?
  trialUsed       Boolean  @default(false)
  User            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceId])
  @@index([isActive])
  @@index([lastValidatedAt])
  @@index([userId])
  @@index([deviceId])
}

model CurrencyRate {
  id          String   @id @default(cuid())
  currency    String   @unique @db.VarChar(3)
  rateToUSD   Float
  lastUpdated DateTime @default(now())

  @@index([currency])
  @@index([lastUpdated])
}

model Download {
  id           String   @id @default(cuid())
  userId       String
  version      String   @db.VarChar(20)
  platform     String   @db.VarChar(20)
  downloadedAt DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([downloadedAt])
  @@index([userId])
}

model User {
  id                           String            @id @default(cuid())
  email                        String            @unique
  name                         String?
  passwordHash                 String
  language                     String            @default("en") @db.VarChar(5)
  preferredCurrency            String            @default("USD") @db.VarChar(3)
  detectedCountry              String?           @db.VarChar(2)
  trialStartAt                 DateTime          @default(now())
  trialEndAt                   DateTime
  subscriptionStatus           String            @default("trial") @db.VarChar(20)
  subscriptionType             String?           @db.VarChar(20)
  planTier                     String?           @db.VarChar(20)
  deviceLimit                  Int               @default(1)
  licenseKey                   String?           @unique @db.VarChar(100)
  lemonSqueezyCustomerId       String?           @db.VarChar(100)
  lemonSqueezySubscriptionId   String?           @db.VarChar(100)
  perpetualLicensePurchasedAt  DateTime?
  perpetualLicenseUpdatesUntil DateTime?
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @updatedAt
  emailVerified                DateTime?
  resetToken                   String?           @db.VarChar(255)
  resetTokenExpiry             DateTime?
  verificationToken            String?           @db.VarChar(255)
  verificationTokenExpiry      DateTime?
  ActivatedDevice              ActivatedDevice[]
  Download                     Download[]

  @@index([createdAt])
  @@index([email])
  @@index([licenseKey])
  @@index([resetToken])
  @@index([subscriptionStatus])
  @@index([verificationToken])
}
